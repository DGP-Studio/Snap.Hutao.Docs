---
headerDepth: 2
category: [FAQ]
icon: iconfont icon-read
order: 8
comment: false
description: Snap Hutaoは、ユーザーのログイン情報を取得し、原神APIと連携して祈願履歴を取得するために、複数の方法を使用します。
banner: https://opengraph.snapgenshin.cn/generate?url=https://hut.ao/zh/advanced/Gacha-system-and-export-principal.html&has_description=False
---

# 祈願システムとエクスポートの原理

> Gacha System and Principal

胡桃の祈願システムは、Snap Genshinと比較して、アーキテクチャ全体が再設計されています。

この記事では、原神の祈願履歴のメカニズムと、Snap Hutaoの祈願エクスポート機能の技術的な原理について説明します。

---

## 祈願の取得

祈願履歴を取得するには、miHoYoのAPIをリクエストする必要があります。

このAPIには、以下の注意事項があります。

- miHoYoサーバーのAPIを通じて、過去1年間の祈願履歴のみを照会できます。
  - これは、原神クライアントでの祈願履歴のソースでもあります。
- APIにはリクエストレート制限があり、リクエストが速すぎると、後続のリクエストが失敗し、正常にデータを取得できなくなります。

### APIリクエストのキーパラメーター

このAPIをリクエストするには、次の4つのキーパラメーターが必要です。

1. ガチャの種類
2. 抽出アイテム
3. 時間
4. 抽出履歴ID

- 現在、これらのパラメーターを取得する方法として、以下のものが知られています。
  1. Unityのログファイルを調べて、ユーザーが開いた祈願履歴のURLを検索します。
  2. 本機のトラフィックをプロキシし、祈願履歴のURLをフィルタリングします。
  3. `CefBrowser`のブラウザキャッシュを調べて、祈願履歴のURLを見つけます。
  4. `SToken`を含むCookieを使用して`genAuthKey` APIを呼び出し、パラメーターを取得します。
  5. 上級ユーザーに関連URLを手動で入力してもらいます。

### データ連結と完全な履歴の生成

APIをリクエストした後、バラバラの祈願履歴を取得できます。これらの履歴を連結することで、完全な祈願履歴リストを生成できます。

---

## 祈願の保存

完全な祈願履歴リストは、取得後にローカルデータベースにシリアル化されて保存され、必要に応じて逆シリアル化されてユーザーに表示されます。

- 後続のリクエストでは、Snap Hutaoはデータベース内のデータと照合して、追加された部分のデータのみを取得します。
- この方法により、ユーザーはアカウントの完全な祈願履歴を長期にわたって保存できます。

---

## UIGF形式

> 統一可交換祈願記録標準
> Uniformed Interchangeable GachaLog Format Standard

`UIGF`は、私たちが他の祈願履歴アプリケーションと共同で提唱、導入し、**長期的にメンテナンス**している統一された祈願履歴データ交換規格です。

標準化されたデータ形式により、ユーザーは異なるツール間で自由にデータを転送し、各ツールの特徴的な機能を使用できます。

### 祈願のインポート

`UIGF`データ形式を使用すると、他のアプリケーションに保存されている祈願履歴データをインポートできます。

- Snap Hutaoはデータをインポートする際に、ローカルストレージの最も古いインデックス（ID）と比較し、より古い履歴のみをインポートします。
- 新しいデータは常にmiHoYoサーバーから取得でき、元のデータの精度が高くなります。

### 祈願のエクスポート

Snap Hutaoは、祈願履歴を`UIGF`データ形式でファイルとして保存し、ユーザーが指定したフォルダに出力することをサポートしています。

ユーザーは、エクスポートされたファイルを介して、`UIGF`形式をサポートする他のツールで祈願履歴を引き続き使用できます。

::: important
これは Google Gemini モデルによって作成された翻訳であり、PRによる修正を歓迎します。
:::
